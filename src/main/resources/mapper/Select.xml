<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.totalplay.requerimiento.dao.SelectDao">

	<select id="getStatus" resultType="StatsuVo">
		SELECT
			DUMMY MESSAGE,
			TO_CHAR(SYSDATE, 'DD/MM/YYYY') DATES
		FROM DUAL
	</select>
	
	<select id="getRequerimeiinto" resultType="RequerimientosModel">
		SELECT
		    TR.TPGREQID ID,
		    TP.PERMISO,
		    TU1.NAME UBICACION,
		    TU2.NAME MUNICIPIO,
		    TR.VIGENCIA || ' ' || TM.UMEDIDA  VIGENCIA,
            TA.AREA,
		    TO_CHAR(TR.DATEREQ, 'DD/MM/YYYY') FECHAREQ,
		    TO_CHAR(TR.DETEEND, 'DD/MM/YYYY') FECHAVENCIMIENTO,
		    TE.ESTADO,
		    TR.TPGCEID IDESTADO
		FROM TPG_REQUERIMIENTO TR
		    INNER JOIN TPGC_PERMISO TP ON TR.TPGCPID = TP.TPGCPID
		    INNER JOIN TPGC_UBICACION TU1 ON TR.TPGCUID = TU1.TPGCUID
		    INNER JOIN TPGC_UBICACION TU2 ON TR.TPGCUIDREF = TU2.TPGCUID
		    INNER JOIN TPGC_ESTADOS TE ON TR.TPGCEID = TE.TPGCEID
            INNER JOIN TPGC_MEDIDA TM ON TR.TPGCUMID = TM.TPGCUMID
            INNER JOIN TPGC_AREA TA ON TR.TPGCAID = TA.TPGCAID
		<if test="id != null">
			WHERE TR.TPGREQID  = #{id}
		</if>
	</select>
	
	<insert id="setRequerimiento" useGeneratedKeys="true" keyProperty="req.id" keyColumn="TPGREQID">
		INSERT INTO TPG_REQUERIMIENTO(
		    TPGREQID,
		    TPGCPID,
		    TPGCUID,
		    TPGCUIDREF,
		    VIGENCIA,
			TPGCUMID,
			TPGCAID,
		    DATEREQ,
		    DETEEND,
		    TPGCEID,
		    DATEMOD,
		    TPGUID_REQ
		)VALUES(
		    STPGTPGREQID.NEXTVAL,
		    #{req.tipoRequerimineto},
		    #{req.ubicacionEstado},
		    #{req.municipio},
		    #{req.vigencia},
			#{req.umedida},
			#{req.area},
		   	TO_DATE(#{req.fechaRequerimiento},'YYYY-MM-DD'),
		    TO_DATE(#{req.fechaVencimiento},'YYYY-MM-DD'),
		    1,
		    SYSDATE,
		    #{req.idUser}

		)
	</insert>	
	<select id="getRequerimeiintoFilter" resultType="RequerimientosModel">
		SELECT
		    TR.TPGREQID ID,
		    TP.PERMISO,
		    TU1.NAME UBICACION,
		    TU2.NAME MUNICIPIO,
		    TR.VIGENCIA || ' ' || TM.UMEDIDA  VIGENCIA,
            TA.AREA,
		    TO_CHAR(TR.DATEREQ, 'DD/MM/YYYY') FECHAREQ,
		    TO_CHAR(TR.DETEEND, 'DD/MM/YYYY') FECHAVENCIMIENTO,
		    TE.ESTADO,
		    TR.TPGCEID IDESTADO
		FROM TPG_REQUERIMIENTO TR
		    INNER JOIN TPGC_PERMISO TP ON TR.TPGCPID = TP.TPGCPID
		    INNER JOIN TPGC_UBICACION TU1 ON TR.TPGCUID = TU1.TPGCUID
		    INNER JOIN TPGC_UBICACION TU2 ON TR.TPGCUIDREF = TU2.TPGCUID
		    INNER JOIN TPGC_ESTADOS TE ON TR.TPGCEID = TE.TPGCEID
            INNER JOIN TPGC_MEDIDA TM ON TR.TPGCUMID = TM.TPGCUMID
            INNER JOIN TPGC_AREA TA ON TR.TPGCAID = TA.TPGCAID
		<if test="numeric == true">
			WHERE TR.TPGREQID LIKE '%'||#{id}||'%'
		</if>
		<if test="numeric != true">
			WHERE TP.PERMISO LIKE UPPER('%'||#{id}||'%')
		</if>
	</select>	
	
	<insert id="setAddons">
		INSERT INTO TPG_REQADDON(
			TPGREQID,
			FOLIO,
			IMPORTE,
			PAYDATE,
			REGISTROC,
			NOMBRECONT,
			PROVEEDOR,
			SISTEMA,
			TPGCSID,
			FEGRESO,
			TPGCAID,
			CC,
			NOMBRECC,
			POSTFIN,
			INCPERMISO,
			HORARIO,
			NEGACION,
			CANTIDAD,
			VIGENCIA,
			TPGCUMID,
			FORMAPAGO,
			TPGCCID,
			TPGCACID,
			DESCRIPCION,
			FOLIOSAP,
			FOLIOSEG,
			TPGUID_ADMON,
			TPGUID_AUT,
			TPGCUID_ADDON
		)VALUES(
			#{req.idRequerimiento},
			#{req.folio},
			#{req.importe},
                        TO_DATE(#{req.paydate},'YYYY-MM-DD'),
			#{req.registroContable},
			#{req.nombreContacto},
			#{req.proveedor},
			#{req.sistema},
			#{req.tipoSolicitud},
			#{req.folioEgreso},
			#{req.area},
			#{req.cc},
			#{req.nombreCc},
			#{req.postFin},
			#{req.incluidoPermiso},
			#{req.horario},
			#{req.perNeg},
			#{req.catidad},
			#{req.vigencia},
			#{req.medida},
			#{req.formaPago},
			#{req.cobertura},
			#{req.actividad},
			#{req.descripcion},
			#{req.foliosap},			
			#{req.folioseg},
			#{req.idUserAdmon},
			#{req.idUserAut},
			#{req.mIdUser}
		)
	</insert>
        
        <select id="getRequerimientoPorVencer" resultType="RequerimientosModel">
		SELECT
		    TR.TPGREQID ID,
		    TP.PERMISO,
		    TU1.NAME UBICACION,
		    TU2.NAME MUNICIPIO,
		    TR.VIGENCIA || ' ' || TM.UMEDIDA  VIGENCIA,
            TA.AREA,
		    TO_CHAR(TR.DATEREQ, 'DD/MM/YYYY') FECHAREQ,
		    TO_CHAR(TR.DETEEND, 'DD/MM/YYYY') FECHAVENCIMIENTO,
		    TE.ESTADO,
		    TR.TPGCEID IDESTADO,
		    TR.TPGUID_REQ idUser
		FROM TPG_REQUERIMIENTO TR
		    INNER JOIN TPGC_PERMISO TP ON TR.TPGCPID = TP.TPGCPID
		    INNER JOIN TPGC_UBICACION TU1 ON TR.TPGCUID = TU1.TPGCUID
		    INNER JOIN TPGC_UBICACION TU2 ON TR.TPGCUIDREF = TU2.TPGCUID
		    INNER JOIN TPGC_ESTADOS TE ON TR.TPGCEID = TE.TPGCEID
            INNER JOIN TPGC_MEDIDA TM ON TR.TPGCUMID = TM.TPGCUMID
            INNER JOIN TPGC_AREA TA ON TR.TPGCAID = TA.TPGCAID
            WHERE TO_DATE (TR.DETEEND,'DD/MM/YYYY') &lt;= TO_DATE(sysdate+(select valor from tpgc_parametro where TPGCPID=1),'DD/MM/YYYY')
            AND TO_DATE (TR.DETEEND,'DD/MM/YYYY') &gt;= TO_DATE(sysdate,'DD/MM/YYYY')
            AND TR.TPGCEID = 2
            AND TR.TPGCUID=(SELECT TPGCUID FROM tpg_usuarios WHERE username=#{id})
            AND NOT EXISTS (SELECT *FROM tpgc_req_vencidos r WHERE r.folio_req_vencido=TR.TPGREQID)
	</select>
        
        <select id="getRequerimientosVencidos" resultType="RequerimientosModel">
		SELECT
		    TR.TPGREQID ID,
		    TP.PERMISO,
		    TU1.NAME UBICACION,
		    TU2.NAME MUNICIPIO,
		    TR.VIGENCIA || ' ' || TM.UMEDIDA  VIGENCIA,
            TA.AREA,
		    TO_CHAR(TR.DATEREQ, 'DD/MM/YYYY') FECHAREQ,
		    TO_CHAR(TR.DETEEND, 'DD/MM/YYYY') FECHAVENCIMIENTO,
		    TE.ESTADO,
		    TR.TPGCEID IDESTADO,
		    TR.TPGUID_REQ idUser
		FROM TPG_REQUERIMIENTO TR
		    INNER JOIN TPGC_PERMISO TP ON TR.TPGCPID = TP.TPGCPID
		    INNER JOIN TPGC_UBICACION TU1 ON TR.TPGCUID = TU1.TPGCUID
		    INNER JOIN TPGC_UBICACION TU2 ON TR.TPGCUIDREF = TU2.TPGCUID
		    INNER JOIN TPGC_ESTADOS TE ON TR.TPGCEID = TE.TPGCEID
            INNER JOIN TPGC_MEDIDA TM ON TR.TPGCUMID = TM.TPGCUMID
            INNER JOIN TPGC_AREA TA ON TR.TPGCAID = TA.TPGCAID
            WHERE TO_DATE (TR.DETEEND,'DD/MM/YYYY') &gt;= TO_DATE(sysdate-(select valor from tpgc_parametro where TPGCPID=2),'DD/MM/YYYY')
            AND TO_DATE (TR.DETEEND,'DD/MM/YYYY') &lt; TO_DATE(sysdate,'DD/MM/YYYY')
            AND TR.TPGCEID = 2
            AND TR.TPGCUID=(SELECT TPGCUID FROM tpg_usuarios WHERE username=#{id})
            AND NOT EXISTS (SELECT *FROM tpgc_req_vencidos r WHERE r.folio_req_vencido=TR.TPGREQID)
	</select>
        
        <select id="getRequerimientoEstado" resultType="RequerimientosModel">
		SELECT
		    TR.TPGREQID ID,
		    TP.PERMISO,
		    TU1.NAME UBICACION,
		    TU2.NAME MUNICIPIO,
		    TR.VIGENCIA || ' ' || TM.UMEDIDA  VIGENCIA,
            TA.AREA,
		    TO_CHAR(TR.DATEREQ, 'DD/MM/YYYY') FECHAREQ,
		    TO_CHAR(TR.DETEEND, 'DD/MM/YYYY') FECHAVENCIMIENTO,
		    TE.ESTADO,
		    TR.TPGCEID IDESTADO
		FROM TPG_REQUERIMIENTO TR
		    INNER JOIN TPGC_PERMISO TP ON TR.TPGCPID = TP.TPGCPID
		    INNER JOIN TPGC_UBICACION TU1 ON TR.TPGCUID = TU1.TPGCUID
		    INNER JOIN TPGC_UBICACION TU2 ON TR.TPGCUIDREF = TU2.TPGCUID
		    INNER JOIN TPGC_ESTADOS TE ON TR.TPGCEID = TE.TPGCEID
            INNER JOIN TPGC_MEDIDA TM ON TR.TPGCUMID = TM.TPGCUMID
            INNER JOIN TPGC_AREA TA ON TR.TPGCAID = TA.TPGCAID
            WHERE TR.TPGCUID=(SELECT TPGCUID FROM tpg_usuarios WHERE username=#{id}) ORDER BY TPGREQID DESC
	</select>
        <select id="getRequerimientoCompleto" resultType="RequAddonModel">
		SELECT 
                TPGREQID idRequerimiento,FOLIO,IMPORTE, PAYDATE,REGISTROC registroContable,NOMBRECONT nombreContacto,PROVEEDOR,
                SISTEMA,tpgcsid tipoSolicitud,FEGRESO folioEgreso,TPGCAID area,CC,NOMBRECC,POSTFIN,INCPERMISO incluidoPermiso,HORARIO,
                NEGACION perNeg,CANTIDAD catidad,VIGENCIA,TPGCUMID medida,FORMAPAGO,TPGCCID cobertura,TPGCACID actividad,DESCRIPCION,FOLIOSAP,FOLIOSEG,TPGUID_ADMON idUserAdmon,TPGUID_AUT idUserAut, TPGCUID_ADDON mIdUser  
                FROM TPG_REQADDON 
		<if test="id != null">
			WHERE TPGREQID  = #{id}
		</if>
	</select>
        <insert id="setRequerimientoRelacion" useGeneratedKeys="true" keyProperty="req.id" keyColumn="TPGCREQID">
		INSERT INTO TPGC_REQ_VENCIDOS(
		    TPGCREQID,
		    FOLIO_REQ_VENCIDO,
		    FOLIO_REQ_NUEVO,
		    FECHA_CREACION,
		    USUARIO_ID,
                    ES_VENCIDA
		)VALUES(
		    STPGCREVEID.NEXTVAL,
		    #{req.folioVencido},
		    #{req.folioNuevo},
		    TO_DATE(CURRENT_DATE,'YYYY-MM-DD'),
		    #{req.user},
		    #{req.vencida}
		)
	</insert>
        <insert id="setRequerimientoReact" >
		INSERT INTO TPG_REQUERIMIENTO(
		    TPGREQID,
		    TPGCPID,
		    TPGCUID,
		    TPGCUIDREF,
		    VIGENCIA,
			TPGCUMID,
			TPGCAID,
		    DATEREQ,
		    DETEEND,
		    TPGCEID
		) 
                    SELECT STPGTPGREQID.NEXTVAL,TPGCPID,
		    TPGCUID,
		    TPGCUIDREF,
		    VIGENCIA,
			TPGCUMID,
			TPGCAID,
		    DATEREQ,
		    DETEEND,
		    TPGCEID
		    FROM TPG_REQUERIMIENTO WHERE TPGREQID=#{id}
		    
	</insert>
        <insert id="cambiaEstatusRequerimiento" >
		UPDATE TPG_REQUERIMIENTO
                SET TPGCEID = #{idEstatus}
                WHERE TPGREQID=#{id}		    
	</insert>
        <insert id="addComentario" useGeneratedKeys="true" keyProperty="req.id" keyColumn="TPGCOID">
            INSERT INTO TPGC_COMENTARIOS(
                TPGCOID ,
                TPGUID ,
                USERNAME ,
                COMENTARIO ,
                FECHA_CREACION ,
                TPGREQID ,
                TPGCOID_REPLY )
            VALUES(
                coment_seq.NEXTVAL,
		#{req.idUser},
		#{req.usuario},
		#{req.comentario},
                TO_DATE(CURRENT_DATE,'YYYY-MM-DD'),
		#{req.idRequerimiento},
		#{req.idComentarioReply}
            )
        </insert>
        <select id="getComentarios" resultType="ComentariosModel">
            SELECT 
                TPGCOID id,
                TPGUID idUser,
                USERNAME usuario,
                COMENTARIO comentario,
                FECHA_CREACION fechaCreacion,
                TPGREQID idRequerimiento,
                TPGCOID_REPLY idComentarioReply FROM TPGC_COMENTARIOS
             WHERE TPGREQID=#{id} ORDER BY TPGCOID ASC
        </select>
        <insert id="addParametro">
            INSERT INTO TPGC_PARAMETRO(
                TPGCPID ,TIPO,VALOR ,ENABLED,FECHA_CREACION )
            VALUES(
                #{req.id},
		#{req.tipo},
		#{req.valor},
		#{req.enabled},
                TO_DATE(CURRENT_DATE,'YYYY-MM-DD')
            )
        </insert>
        <select id="getParametros" resultType="ParametroModel">
            SELECT TPGCPID id ,TIPO tipo,VALOR valor,ENABLED enabled,FECHA_CREACION fecha_creacion
            FROM
            TPGC_PARAMETRO
            where TPGCPID=#{id}
        </select>
        <select id="getRequermientoIds" resultType="RequerimientosModel">
		SELECT
		    TR.TPGREQID ID,
		    TPGCPID PERMISO,
		    TPGCUID UBICACION,
		    TPGCUIDREF MUNICIPIO,
		    TR.VIGENCIA || ' ' || TPGCUMID  VIGENCIA,
            TPGCAID AREA,
		    TO_CHAR(TR.DATEREQ, 'DD/MM/YYYY') FECHAREQ,
		    TO_CHAR(TR.DETEEND, 'DD/MM/YYYY') FECHAVENCIMIENTO,
		    TPGCEID ESTADO,
		    TR.TPGCEID IDESTADO,
		    TPGUID_REQ idUser
		FROM TPG_REQUERIMIENTO TR
		<if test="id != null">
			WHERE TR.TPGREQID  = #{id}
		</if>
	</select>
    <update id="updateRequerimiento" >
		UPDATE TPG_REQUERIMIENTO 
		    
		    SET TPGCPID=#{req.tipoRequerimineto},
		     TPGCUID=#{req.ubicacionEstado},
		     TPGCUIDREF=#{req.municipio},
		     VIGENCIA=#{req.vigencia},
		     TPGCUMID=#{req.umedida},
		     TPGCAID=#{req.area},
		     DATEREQ=TO_DATE(#{req.fechaRequerimiento},'YYYY-MM-DD'),
		     DETEEND=TO_DATE(#{req.fechaVencimiento},'YYYY-MM-DD')
		where
            TPGREQID=#{req.id}
	</update>
	
	 <update id="updateRequerimientoAddon" >
		UPDATE TPG_REQADDON 
		    
		    SET FOLIO=#{req.folio},
		     IMPORTE=#{req.importe},
		     PAYDATE=TO_DATE(#{req.paydate},'YYYY-MM-DD'),
		     REGISTROC=#{req.registroContable},
		     NOMBRECONT=#{req.nombreContacto},
		     PROVEEDOR=#{req.proveedor},
		     SISTEMA=#{req.sistema},
		     TPGCSID=#{req.tipoSolicitud},
		     FEGRESO=#{req.folioEgreso},
		     TPGCAID=#{req.area},
		     CC=#{req.cc},
		     NOMBRECC=#{req.nombreCc},
		     POSTFIN=#{req.postFin},
		     INCPERMISO=#{req.incluidoPermiso},
		     HORARIO=#{req.horario},
		     NEGACION=#{req.perNeg},
		     CANTIDAD=#{req.catidad},
		     VIGENCIA=#{req.vigencia},
		     TPGCUMID=#{req.medida},
		     FORMAPAGO=#{req.formaPago},
		     TPGCCID=#{req.cobertura},
		     TPGCACID=#{req.actividad},
		     DESCRIPCION=#{req.descripcion},
		     FOLIOSAP=#{req.foliosap},
		     FOLIOSEG=#{req.folioseg},
		     TPGUID_ADMON=#{req.idUserAdmon},
		     TPGUID_AUT=#{req.idUserAut}
		where
            TPGREQID=#{req.idRequerimiento}
	</update>
	
	 <insert id="setFechaVigencia" >
		INSERT INTO TPG_FECHAS_VIGENCIA(
		    TPGFECHAID,
		    TPGREQID,
		    TPGVIGENCIA,
		    TPGUNIDAD,
		    TPGFECHAREQ,
			TPGFECHAVIGENCIA
		) VALUES(
			TPGFECHAIDSec.NEXTVAL,
			#{req.idReq},
			#{req.vigencia},
			#{req.unidad},
            TO_DATE(#{req.fechaReq},'YYYY-MM-DD'),
            TO_DATE(#{req.fechaVigencia},'YYYY-MM-DD')
		)
		    
	</insert>
	
	<select id="getFechasVigencia" resultType="FechaVigenciaModel">
            SELECT 
            	TF.TPGFECHAID id,
            	TF.TPGREQID idReq,
            	TF.TPGVIGENCIA vigencia,
            	TF.TPGUNIDAD unidad,
            	TF.TPGFECHAREQ fechaReq,
            	TF.TPGFECHAVIGENCIA fechaVigencia
            FROM
            TPG_FECHAS_VIGENCIA TF 
        <if test="id != null">
		WHERE TF.TPGREQID  = #{id}
		</if>
    </select>
    

    
    <update id="updateFechaVigencia" >
		UPDATE TPG_FECHAS_VIGENCIA 
		    SET TPGREQID = #{id}
		where
            TPGREQID='tmpReq'
	</update>
	
	<delete id="deleteFechaVigencia">
	DELETE FROM TPG_FECHAS_VIGENCIA
	WHERE TPGFECHAID=#{id}
	</delete>
	
	<insert id="setActividades" >
		INSERT INTO TPG_ACTIVIDADES_REQ(
		    TPGCACREQID,
		    TPGCREQID,
		    TPGCACID
		) VALUES(
			TPGCACREQID_seq.NEXTVAL,
			#{act.tpgcreqid},
			#{act.tpgcacid}
		)
		    
	</insert>
	
	    <select id="getListRequerimientoByUser" resultType="RequAddonModel">
				SELECT 
                TPGREQID idRequerimiento,FOLIO,IMPORTE, PAYDATE,REGISTROC registroContable,NOMBRECONT nombreContacto,PROVEEDOR,
                SISTEMA,tpgcsid tipoSolicitud,FEGRESO folioEgreso,TPGCAID area,CC,NOMBRECC,POSTFIN,INCPERMISO incluidoPermiso,HORARIO,
                NEGACION perNeg,CANTIDAD catidad,VIGENCIA,TPGCUMID medida,FORMAPAGO,TPGCCID cobertura,TPGCACID actividad,DESCRIPCION,FOLIOSAP,FOLIOSEG,TPGUID_ADMON idUserAdmon,TPGUID_AUT idUserAut, TPGCUID_ADDON mIdUser  
                FROM TPG_REQADDON WHERE TPGCUID_ADDON = #{id} OR TPGUID_AUT = #{id} OR TPGUID_ADMON = #{id}
    </select>
    

</mapper>